---
const pageTitle = "Christmas Quest per POLLOOOOO";
const description = "Piccolo gioco di Natale a indovinelli per scoprire gli indizi nascosti in casa.";
---

<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>{pageTitle}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
  </head>
  <body>
    <main class="app">
      <section id="hero" class="hero">
        <div class="hero-header">
          <span class="hero-badge">Secret · Santa</span>
          <h1>{pageTitle}</h1>
        </div>
        <p>
          È la vigilia di Natale e questo gioco è pensato solo per te.
          Leggi gli indovinelli sullo schermo, fai i piccoli movimenti richiesti
          e lascia che chi è con te ti aiuti a costruire, bendato, un regalo segreto sul pavimento.
        </p>
        <button id="start-btn" class="btn-primary">Inizia la magia</button>
      </section>

      <section id="steps" class="steps hidden">
        <div class="step-header">
          <button
            id="prev-step"
            class="step-nav-btn"
            aria-label="Indietro indovinello"
          >
            ◀
          </button>
          <div class="step-header-main">
            <h2 id="step-title"></h2>
            <p id="progress" class="progress"></p>
          </div>
          <button
            id="next-step"
            class="step-nav-btn"
            aria-label="Prossimo indovinello"
          >
            ▶
          </button>
        </div>
        <div class="racket-placeholder"></div>
        <p id="step-prompt" class="step-prompt"></p>

        <div class="step-actions">
          <button id="group-btn" class="btn-secondary">Appunto segreto per il gruppo</button>
          <button id="next-btn" class="btn-primary">
            <span id="next-label">Mostra indizio</span>
          </button>
        </div>

        <p id="step-build" class="step-build"></p>
        <div id="step-clue" class="step-clue hidden"></div>
      </section>

      <div id="group-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-dialog">
          <h3 class="modal-title">Appunto segreto per il gruppo</h3>
          <p id="modal-build" class="modal-build"></p>
          <button id="modal-close" class="btn-secondary modal-close-btn">Chiudi</button>
        </div>
      </div>

      <section id="final" class="final hidden">
        <h2>Il gioco del civico</h2>
        <div class="frame"></div>
        <p>
          Hai raccolto tutti gli indizi e tutti i bigliettini.
          Ora pensa al gioco che facevi da piccolo lanciando in aria
          qualcosa di speciale legato al numero di casa.
        </p>
        <p>
          Quando avrai indovinato, qualcuno ti consegnerà il vero regalo:
          una cornice che profuma di ricordi e di casa.
        </p>
      </section>

      <audio id="bg-music" src="/audio/christmas.mp3" loop></audio>
    </main>

    <script>
      const hero = document.getElementById("hero");
      const stepsSection = document.getElementById("steps");
      const finalSection = document.getElementById("final");
      const startBtn = document.getElementById("start-btn");
      const nextBtn = document.getElementById("next-btn");
      const nextLabel = document.getElementById("next-label");
      const prevStepBtn = document.getElementById("prev-step");
      const nextStepBtn = document.getElementById("next-step");
      const titleEl = document.getElementById("step-title");
      const promptEl = document.getElementById("step-prompt");
      const buildEl = document.getElementById("step-build");
      const clueEl = document.getElementById("step-clue");
      const progressEl = document.getElementById("progress");
      const music = document.getElementById("bg-music");
      const groupBtn = document.getElementById("group-btn");
      const groupModal = document.getElementById("group-modal");
      const modalBuildEl = document.getElementById("modal-build");
      const modalClose = document.getElementById("modal-close");

      const steps = [
        {
          title: "1 · Re della casa in movimento",
          prompt: `INDOVINELLO 1
In questa casa c e qualcuno che non sta mai fermo:
lava, cucina, sistema e corre da una stanza all altra.
Leggi ad alta voce e poi fai qualche passo come se stessi passando lo straccio sul pavimento.
Solo dopo il movimento, premi "Mostra indizio" qui sotto per scoprire dove andare.`,
          build: `Quando Pierpaolo torna con il primo bigliettino, non leggetelo ad alta voce.
Guardate il piccolo disegno sul foglio: per voi è la traccia principale di una mappa segreta.
Fate sapere al gruppo che per questo primo livello l oggetto dell indovinello sarà la "linea lunga": dopo averlo fatto sedere o girare, chiedetegli di tornare nel punto dell indizio e scegliere un oggetto che secondo lui rappresenta bene la scena (senza dirgli perché).
Quando rientra, fatevelo consegnare e guidatelo ad appoggiarlo a terra seguendo la direzione del disegno, come una singola traccia lunga della mappa.
Se volete, potete decidere che questa prima traccia valga una o più "lunghezze" di quello stesso oggetto, aggiungendone altri uguali accanto finché la mappa vi convince, senza mai nominare figure o regali.`,
          clue: `Nel regno di piatti, spugne e sapone,
tra acqua che scorre e un po' di schiumone,
c e un biglietto che aspetta nascosto bene:
cercalo dove lavi pentole, piatti e posate ogni sere.
Quando lo trovi, riportalo al gruppo senza farlo leggere a nessun altro.`
        },
        {
          title: "2 · Dal calcio al tennis",
          prompt: `INDOVINELLO 2
Una volta il rumore era quello del pallone sul cemento,
oggi e il colpo pulito di una racchetta in movimento.
Leggi e poi mima un servizio di tennis: lancio della pallina e colpo deciso.
Quando hai finito il servizio, premi "Mostra indizio" per continuare.`,
          build: `Quando Pierpaolo porta il secondo bigliettino, tenetelo per voi.
Sul foglio vedete un nuovo segno che non mostra quello di prima.
Scegliete per questo livello uno o più oggetti di scena diversi dal primo (che parlino un po di sport, se vi piace) e fate aggiungere a Pierpaolo una nuova linea a terra ispirandovi al disegno.
Potete decidere se questa traccia vale più o meno "unità" rispetto a quella della cucina, usando una combinazione degli oggetti di scena che avete scelto, senza mai parlare di rettangoli o numeri.`,
          clue: `C era il pallone, ora c e la racchetta,
che aspetta silenziosa la prossima partita perfetta.
Vicino alla borsa da sport o dove riposa il tuo tennis fedele,
troverai il biglietto con il prossimo segreto da svelare.
Quando lo trovi, riportalo di nuovo al gruppo in silenzio.`
        },
        {
          title: "3 · Meglio fuori che sul divano",
          prompt: `INDOVINELLO 3
Dove ti senti davvero te stesso: chiuso in casa o con le scarpe gia pronte alla porta?
Leggi e poi fai qualche passo sul posto come se stessi infilando le scarpe per uscire.
Quando hai fatto qualche passo, premi "Mostra indizio" per scoprire dove andare.`,
          build: `Con il terzo bigliettino il disegno inizia a sembrare ancora più strano.
Il gruppo prende gli oggetti di scena morbidi che avete scelto (magliette, sciarpe, asciugamani, cappelli...) e riempie un po lo spazio tra le linee che avete già creato, seguendo la sensazione del disegno sul foglio.
Pierpaolo deve solo eseguire i vostri comandi, senza mai vedere il risultato.
Se volete, potete inventare una vostra "unità" per questo livello (una lunghezza di sciarpa, due cappelli, tre magliette) e usarla per decidere dove farlo fermare o quanto deve essere lunga una parte della mappa.`,
          clue: `Per uno che in casa non riesce a stare,
la porta è sempre pronta a farti passare.
Vicino alle scarpe o al posto dove lasci le sneaker al rientro,
un altro biglietto ti aspetta, pronto al decollo.
Quando lo trovi, riportalo al gruppo come se fosse un nuovo pezzo di mappa.`
        },
        {
          title: "4 · Viaggiatore natalizio",
          prompt: `INDOVINELLO 4
Tra luci di Natale e valigie pronte,
le tue foto raccontano piu aeroporti che salotti.
Leggi e poi mima il gesto di tirare un trolley verso una nuova avventura.
Quando hai finito di trascinare il tuo trolley immaginario, premi "Mostra indizio" per la prossima missione.`,
          build: `Il quarto bigliettino porta un disegno ancora diverso.
Per questo livello scegliete oggetti di scena che parlino di viaggi (valigie piccole, zainetti, beauty case, cuscini da volo...) e usateli per aggiungere nuove tracce ispirate al foglio.
Ogni volta che Pierpaolo si muove o appoggia qualcosa seguendo le vostre istruzioni, per lui sarà solo una serie di gesti, per voi una mappa che prende forma.
Potete decidere che uno di questi oggetti valga come "lato lungo" della vostra mappa e usare gli altri per riempire o allungare le zone che vi divertono di più.`,
          clue: `Chi ama partire ha sempre una valigia a portata di mano,
pronta per un weekend o magari per un lungo piano.
Cerca il biglietto vicino al trolley o allo zaino da viaggio,
lì ti aspetta il penultimo passaggio.
Quando lo trovi, riportalo al gruppo come se fosse quasi l ultimo pezzo del puzzle.`
        },
        {
          title: "5 · Il ricordo del civico",
          prompt: `INDOVINELLO 5
Da piccolo c era un gioco un po particolare:
lanciare in aria qualcosa con un numero speciale.
Leggi e poi mima il gesto di lanciare una cornice con il numero di casa verso il cielo (solo con le mani).
Solo dopo il gesto finale, premi "Mostra indizio" per l ultimo segnale della serata.`,
          build: `Con l ultimo bigliettino non dovete cambiare più nulla a terra.
Dopo il movimento finale, fate solo in modo che Pierpaolo si giri dando le spalle alla vostra opera segreta.
Spiegategli che dietro di lui c è il disegno completo nato da tutti i bigliettini, ma potrà davvero guardarlo solo quando il gioco sarà finito.`,
          clue: `L ultimo indizio vive vicino alla porta speciale,
quella che porta il numero della storia principale.
Cerca vicino al campanello o al civico ben in vista,
lì il biglietto finale chiude tutta la lista.
Quando lo trovi, portalo al gruppo: da lì in poi la sorpresa passa nelle loro mani.`
        }
      ];

      let current = 0;
      let showingClue = false;
      let touchStartX = null;
      let touchEndX = null;

      function renderStep() {
        const step = steps[current];
        titleEl.textContent = step.title;
        promptEl.textContent = step.prompt;
        buildEl.textContent = step.build || "";
        if (modalBuildEl) {
          modalBuildEl.textContent = step.build || "";
        }
        clueEl.textContent = "";
        clueEl.classList.add("hidden");
        showingClue = false;
        if (nextLabel) {
          nextLabel.textContent = "Mostra indizio";
        }
        if (prevStepBtn) {
          prevStepBtn.disabled = current === 0;
        }
        if (nextStepBtn) {
          nextStepBtn.disabled = current === steps.length - 1;
        }
        progressEl.textContent = "Indovinello " + (current + 1) + " di " + steps.length;
      }

      if (startBtn) {
        startBtn.addEventListener("click", function () {
          hero.classList.add("hidden");
          stepsSection.classList.remove("hidden");
          renderStep();
          if (music) {
            music.play().catch(function () {});
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener("click", function () {
          if (!showingClue) {
            const step = steps[current];
            clueEl.textContent = step.clue;
            clueEl.classList.remove("hidden");
            showingClue = true;
            if (current === steps.length - 1) {
              if (nextLabel) {
                nextLabel.textContent = "Vai al regalo finale";
              }
            } else {
              if (nextLabel) {
                nextLabel.textContent = "Prossimo indovinello";
              }
            }
          } else {
            if (current < steps.length - 1) {
              current += 1;
              renderStep();
            } else {
              stepsSection.classList.add("hidden");
              finalSection.classList.remove("hidden");
            }
          }
        });
      }

      function goToPreviousStep() {
        if (current > 0) {
          current -= 1;
          renderStep();
        }
      }

      function goToNextStepFromHeader() {
        if (current < steps.length - 1) {
          current += 1;
          renderStep();
        }
      }

      if (prevStepBtn) {
        prevStepBtn.addEventListener("click", function () {
          goToPreviousStep();
        });
      }

      if (nextStepBtn) {
        nextStepBtn.addEventListener("click", function () {
          goToNextStepFromHeader();
        });
      }

      function openGroupModal() {
        if (!groupModal) return;
        groupModal.classList.remove("hidden");
      }

      function closeGroupModal() {
        if (!groupModal) return;
        groupModal.classList.add("hidden");
      }

      if (groupBtn) {
        groupBtn.addEventListener("click", function () {
          openGroupModal();
        });
      }

      if (modalClose) {
        modalClose.addEventListener("click", function () {
          closeGroupModal();
        });
      }

      if (groupModal) {
        groupModal.addEventListener("click", function (event) {
          if (event.target === groupModal) {
            closeGroupModal();
          }
        });
      }

      function handleTouchStart(event) {
        if (!event.touches || event.touches.length !== 1) return;
        touchStartX = event.touches[0].clientX;
        touchEndX = null;
      }

      function handleTouchMove(event) {
        if (!event.touches || event.touches.length !== 1) return;
        touchEndX = event.touches[0].clientX;
      }

      function handleTouchEnd() {
        if (touchStartX === null || touchEndX === null) return;
        const deltaX = touchEndX - touchStartX;
        const threshold = 40; // minimo movimento per contare come swipe
        if (Math.abs(deltaX) < threshold) return;

        if (deltaX > 0) {
          // swipe verso destra -> step precedente
          goToPreviousStep();
        } else {
          // swipe verso sinistra -> step successivo
          goToNextStepFromHeader();
        }

        touchStartX = null;
        touchEndX = null;
      }

      if (stepsSection) {
        stepsSection.addEventListener("touchstart", handleTouchStart, { passive: true });
        stepsSection.addEventListener("touchmove", handleTouchMove, { passive: true });
        stepsSection.addEventListener("touchend", handleTouchEnd);
      }
    </script>

    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #22c1c3, #0f172a 50%, #020617 100%);
        color: #f9fafb;
      }

      .app {
        max-width: 840px;
        width: 100%;
        margin: 16px;
        padding: 24px 18px 26px;
        border-radius: 24px;
        background: rgba(15, 23, 42, 0.92);
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(248, 250, 252, 0.1);
      }

      .hero,
      .steps,
      .final {
        display: grid;
        gap: 16px;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(2rem, 2.8vw, 2.4rem);
      }

      .hero-header {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 8px;
      }

      .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        align-self: flex-start;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.78rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #fefce8;
        background: linear-gradient(120deg, rgba(248, 250, 252, 0.18), rgba(250, 204, 21, 0.55));
        box-shadow: 0 0 16px rgba(251, 191, 36, 0.7);
      }

      .hero p {
        margin: 0 0 14px;
        color: #e5e7eb;
        line-height: 1.5;
      }

      .steps {
        margin-top: 6px;
      }

      .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .step-header-main {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }

      .step-nav-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
        font-size: 0.9rem;
        cursor: pointer;
        flex-shrink: 0;
      }

      .step-nav-btn:disabled {
        opacity: 0.35;
        cursor: default;
      }

      .racket-placeholder {
        width: 72px;
        height: 72px;
        border-radius: 999px;
        border: 3px solid rgba(248, 250, 252, 0.9);
        background: radial-gradient(circle at top, rgba(248, 250, 252, 0.3), rgba(15, 23, 42, 1));
      }

      .step-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 4px;
      }

      .step-question {
        margin: 4px 0 4px;
        font-size: 1.02rem;
      }

      .step-prompt {
        margin: 4px 0 8px;
        font-size: 0.98rem;
        white-space: pre-line;
      }

      .step-build {
        display: none;
      }

      .progress {
        margin: 2px 0 0;
        font-size: 0.86rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: #fbbf24;
      }

      .step-clue {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(252, 211, 77, 0.12), rgba(248, 250, 252, 0.04));
        border: 1px solid rgba(252, 211, 77, 0.4);
        white-space: pre-line;
        font-size: 0.96rem;
      }

      .final h2 {
        margin-top: 0;
        margin-bottom: 8px;
      }

      .final p {
        margin: 4px 0;
        color: #e5e7eb;
      }

      .frame {
        width: 120px;
        height: 80px;
        border-radius: 18px;
        border: 4px solid #fbbf24;
        margin-bottom: 10px;
        box-shadow: 0 0 24px rgba(252, 211, 77, 0.8);
        transform: rotate(-4deg);
        animation: floatFrame 3s ease-in-out infinite;
      }

      .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 9px 20px;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        font-size: 0.98rem;
        cursor: pointer;
        color: #111827;
        background: linear-gradient(120deg, #fee2e2, #fbbf24, #bbf7d0);
        background-size: 220% 220%;
        box-shadow: 0 0 24px rgba(252, 211, 77, 0.8);
        transition: transform 0.12s ease, box-shadow 0.12s ease, background-position 0.9s ease;
      }

      .btn-primary:hover {
        transform: translateY(-1px) scale(1.02);
        background-position: 100% 0;
        box-shadow: 0 0 28px rgba(252, 211, 77, 0.95);
      }

      .btn-secondary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 7px 14px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        font-size: 0.86rem;
        font-weight: 500;
        cursor: pointer;
      }

      .btn-secondary:hover {
        background: rgba(30, 64, 175, 0.9);
        border-color: rgba(191, 219, 254, 0.9);
      }

      .btn-arrow {
        font-size: 0.9rem;
        opacity: 0.85;
      }

      .btn-arrow-left {
        margin-right: 4px;
      }

      .btn-arrow-right {
        margin-left: 4px;
      }

      .hidden {
        display: none;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }

      .modal.hidden {
        display: none;
      }

      .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(4px);
      }

      .modal-dialog {
        position: relative;
        max-width: 480px;
        width: calc(100% - 32px);
        background: rgba(15, 23, 42, 0.98);
        border-radius: 20px;
        border: 1px solid rgba(248, 250, 252, 0.16);
        padding: 16px 18px 14px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        z-index: 1;
      }

      .modal-title {
        margin: 0 0 6px;
        font-size: 0.96rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #bfdbfe;
      }

      .modal-build {
        margin: 0 0 10px;
        font-size: 0.94rem;
        white-space: pre-line;
        color: #e5e7eb;
      }

      .modal-close-btn {
        margin-top: 2px;
      }

      @keyframes floatFrame {
        0%,
        100% {
          transform: rotate(-4deg) translateY(0);
        }
        50% {
          transform: rotate(0deg) translateY(-6px);
        }
      }

      @media (max-width: 640px) {
        .app {
          margin: 10px;
          padding: 18px 14px 20px;
        }

        .step-header {
          align-items: flex-start;
        }

        .racket-placeholder {
          width: 60px;
          height: 60px;
        }

        .step-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .btn-primary,
        .btn-secondary {
          width: 100%;
        }

        .modal-dialog {
          width: calc(100% - 24px);
          padding: 14px 14px 12px;
        }
      }
    </style>
  </body>
</html>
